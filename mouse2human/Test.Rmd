---
title: "scaled human model"
output: pdf_document
author: "YL"
date: '`r format(Sys.Date(), "%B %d, %Y")`'
---

# Overview

Goal: to scale an integrated model from mouse to human


```{r setup}
rm(list=ls())  #Clear out existing objects
gc()

# load required packages
library(tidyverse)
library(mrgsolve)
library(gridExtra)
library(grid)

setwd(dirname(rstudioapi::getSourceEditorContext()$path)) # set the working directory at the folder that contains the script
```


# CD4+ exit peripheral rate tuning
```{r}
mod <- mread("erythroid_lymphoid_myeloid") %>% param(CLP2DN_amp = 512, gamma = 2.2)

exidata0 <- expand.idata(exit_peripheral_cd4 = c(0.015, 0.3, 0.4, 0.5, 0.55, 0.6, 0.7))

sim0 <- mod %>% init(LT0 = 1200) %>% idata_set(exidata0) %>% mrgsim(end = 1500) %>% filter(time == 1500)

tmp = merge(x = exidata0, y = sim0, by = "ID", all.x = TRUE)

plot1 = ggplot(data = tmp) + 
  geom_point(aes(x = exit_peripheral_cd4, y = (cd4rec0/cd8rec0))) + 
  labs(y = 'blood CD4+:CD8+ ratio', x = 'rate of naive CD4+ T cell exit peripheral tissues', color = '') + theme_bw()

plot2 = ggplot(data = tmp) + 
  geom_point(aes(x = exit_peripheral_cd4, y = Tconc)) + 
  labs(y = 'blood T cell count (uL-1)', x = 'rate of naive CD4+ T cell exit peripheral tissues', color = '') + theme_bw()

grid.arrange(plot1, plot2, ncol = 2)

ggsave("img/cd4_peripheral_exit_rate_scan.png", plot = plot1, width = 10, height = 4, units = c("in"), dpi = 300)
```

## steady state check
```{r}
# simulate data for steady state

mod <- mread("erythroid_lymphoid_myeloid") %>% param(CLP2DN_amp = 512, gamma = 2.2, exit_peripheral_cd4 = 0.55)

sim0 <- mod %>% init(LT0 = 1200) %>% mrgsim(end = 1500) %>% filter(time == 1500)
```

## sensitivity analysis over thymic output

```{r}
# thymic output is changed by modulating CLP influx into the thymus

mod <- mread("erythroid_lymphoid_myeloid") %>% param(CLP2DN_amp = 512, gamma = 2.2, exit_peripheral_cd4 = 0.55)

exidata0 <- expand.idata(alphaCLP2DN = c(3e-5, 6e-5, 1.2e-4, 2.5e-4, 5e-4, 1e-3, 1e-2, 0.1))

sim0 <- mod %>% init(LT0 = 1200) %>% idata_set(exidata0) %>% mrgsim(end = 1500) %>% filter(time == 1500) 

res <- sim0 %>% select(ID, thymic_output, naiveTprof, DN, DP, SP4thymus, SP8thymus, Tconc, nT_lymphnodes, nT_peripheral) %>%
      merge(y = exidata0, by = "ID", all.x = TRUE) %>% 
      mutate(thymocyte = DN + DP + SP4thymus + SP8thymus)


plot1 = ggplot(data = res) + geom_point(aes(x = thymic_output, y = Tconc)) + scale_x_continuous(trans='log10') + 
  labs(x = 'thymic output (cells/day)', y = 'blood T cell conc (uL-1)', color = '') + theme_bw()

# track the naive T cells generated by difference sources
plot2 = ggplot(data = res) + theme_bw() + geom_point(aes(x = thymic_output, y = naiveTprof)) + scale_x_continuous(trans='log10') + 
        labs(x = 'thymic output (cells/day)', y = 'naive T peripheral proliferation (cells/day)', color = '') 

plot3 = ggplot(data = res) + theme_bw() + scale_x_continuous(trans='log10') + 
        geom_line(aes(x = thymic_output, y = nT_lymphnodes, color = 'LN nT')) + 
        geom_line(aes(x = thymic_output, y = nT_peripheral, color = 'peripheral nT')) + 
        geom_line(aes(x = thymic_output, y = thymocyte, color = 'thymocyte')) + 
        ylab("naive T cell count") + labs(x = 'thymic output (cells/day)', color = 'naive T count') 

png('img/thymic_scan.png', width = 1000, height = 300)
grid.arrange(plot1, plot2, plot3, ncol = 3)
dev.off()
```

### global sensitivity analysis, what parameter PB T cell count is most sensitive to

```{r}
mod <- mread("erythroid_lymphoid_myeloid") %>% param(CLP2DN_amp = 512, gamma = 2.2, exit_peripheral_cd4 = 0.55)
sim0 <- mod %>% init(LT0 = 1200) %>% mrgsim(end = 1500) %>% filter(time == 1500) %>% select(-c(ID, time))
modo <- mod %>% init(sim0)


library(sensitivity)
library(PKPDmisc)
library(mrgsim.parallel)

set_small <- c('alphaCLP2DN', 'env_naiveT', 'k_nT_pro')
set_big <- c('delta_dp','death_naiveT_cd8', 'death_naiveT_cd4','enter_lymph' ,'enter_peripheral', 'exit_lymph', 'exit_peripheral_cd4', 'exit_peripheral_cd8')

sampleperparam = 100

# create sampling method
gen_samples <- function(n, l, which = names(l), 
                        factor = c(0.01,100), N = NULL) { # NEW ARGUMENT: N, the absolute sampling number per parameter
  
  vars <- tidyselect::vars_select(names(l), !!(enquo(which)))
  
  l <- as.list(l)[vars]
  
  l <- lapply(l, function(x) x*factor )
  
  if(is.numeric(N)) { # NEW
    n <- N*2  
  } else {
    n <- length(l)*n*2
  }
  
  df <- as.data.frame(l)
  
  len <- length(df)
  
  X <- matrix(ncol=len, nrow=n)
  
  colnames(X) <- names(df)
  
  Y <- X
  
  for(i in seq(len)){
    r <- exp(runif(n, log(df[1,i]), log(df[2,i])))
    X[,i] <- r
    r <- exp(runif(n, log(df[1,i]), log(df[2,i])))
    Y[,i] <- r
  }
  
  return(list(x1 = as.data.frame(X), x2 = as.data.frame(Y)))
}

N <- sampleperparam * length(c(set_small,set_big))

# set different variation in each group
sets <- list(
  list(which = set_small, factor = c(0.9, 1.1), N = N, l = param(mod)), 
  list(which = set_big, factor = c(0.5,2), N = N, l = param(mod))
)

# define sensitivity analysis target function
batch_t <- function(x) {
  y = modo %>% 
    idata_set(x) %>%
    mrgsim(obsonly = TRUE) %>% 
    group_by(ID) %>% 
    summarise(tconc = tail(Tconc, n=1)) %>% 
    pull(tconc)
  
}

# Generate parameter space for sensitivity analysis 
## note this requires a big memory (>32GB); do not run unless the current analysis infrastructure is sufficient to handle
#samps <- map(sets, do.call, what = gen_samples)
#samp <- map(c(1,2), ~ map_dfc(samps, .x))

# Global sensitivity analysis
## note this requires a big memory (>64GB); do not run unless the current analysis infrastructure is capable
#tvglobal = sobol2007(batch_t, X1=samp[[1]], X2=samp[[2]], nboot=100)
# plot(tvglobal)
# lines(c(0, length(c(set_small,set_big)) + 1), c(0.05, 0.05), type="l", lty = 2)
#sobolx <- list(S = tvglobal$S , T = tvglobal$T)
#saveRDS(sobolx, file = "GlobalAnalysis_T.rds")

x <- readRDS("GlobalAnalysis_T.rds")
### plot
globSens <- tibble(Parameter = c(set_small,set_big),
                   main = x$S$original,
                   main_lo = x$S$'min. c.i.',
                   main_hi = x$S$'max. c.i.',
                   total = x$T$original,
                   total_lo = x$T$'min. c.i.',
                   total_hi = x$T$'max. c.i.') %>%
  gather(effect, Index, -Parameter, -main_lo, -main_hi, -total_lo, -total_hi) %>%
  mutate(lo = ifelse(effect == "main", main_lo, total_lo),
         hi = ifelse(effect == "main", main_hi, total_hi),
         Effect = factor(effect))

fig_sens_glob <- ggplot(data=globSens, aes(x=Parameter, y=Index, group=Effect, col=Effect)) +
  geom_point(position = position_dodge(width=0.3)) +
  geom_errorbar(aes(ymax=hi, ymin=lo), position=position_dodge(width=0.3), width=0) +
  theme_bw() +
  geom_hline(aes(yintercept=0.05), lty=2) +
  theme(legend.title = element_text(size = 15), legend.text=element_text(size=12)) + 
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1, size = 12))

ggsave('img/GlobalSensT.png', plot = fig_sens_glob, width = 10, height = 4, units = c('in'), dpi = 300)
```



# Human SCD transplant

Not the most suitable one, because the patient's spleen was removed before the gene therapy, and the patient also had multiple severe infection after leaving hospital at day 50 after transplant.

```{r}
mod <- mread("scd_fullmodel") %>% param(CLP2DN_amp = 512, gamma = 2.2)

# pre-equlibrium
pre_sim <- mod  %>% init(LT0 = 1) %>%  mrgsim(end = 365 * 7) %>% as_tibble() %>% tail(n = 1) %>% select(-c(ID, time))

# set up preconditioning
ratioleft = 1-0.9

mod2 <- mod %>% init(pre_sim) %>% 
  init(pre_sim[,1:22] * ratioleft) %>% # progenitor in BM conditioning
  init(pre_sim[,67:72] * ratioleft) %>% # CLP and propreB conditioning
  init(pre_sim[,73:78] * ratioleft) %>% # splenic B cell conditioning
  init(pre_sim[,79:116] * ratioleft) %>% # thymic endures similar conditioning
  init(pre_sim[,117:130] * ratioleft) # conditioning on T cell outside thymus and GMs

## set up initial condition for testing
totalcd34 = 2.8e8 

lthscinit = 1e-6 * totalcd34; 
sthscinit = 1e-5 * totalcd34; 
mppinit = 1e-3 * totalcd34;
cmpinit = 1e-2 * totalcd34; 

sim0 <- mod2 %>% init(LT1 = lthscinit, ST12 = sthscinit, MPP12 = mppinit, CMP12 = cmpinit) %>% mrgsim(end = 365 * 2) %>% as_tibble() 

##------------------- check for the steady state -------------------##
tmp = tail(sim0[, c((ncol(sim0) - 49): ncol(sim0))], n = 1)

##------------------- plot to make sure steady state is reached -------------------##
cellcount = ggplot(data = sim0) + 
  geom_line(aes(x = time/30, y = LTHSC, color = 'LT-HSC abs count')) + 
  geom_line(aes(x = time/30, y = RBCconc, color = 'RBC')) + 
  geom_line(aes(x = time/30, y = RETconc, color = 'RET')) + 
  geom_line(aes(x = time/30, y = Bconc, color = 'naive B')) + 
  geom_line(aes(x = time/30, y = Tconc, color = 'naive T')) + 
  geom_line(aes(x = time/30, y = GMconc, color = 'granulocyte')) + 
  labs(y = 'cell count (#/uL peripheral blood)', x = 'time (months)', color = '') + 
  scale_y_continuous(trans='log10', limits = c(1, 5e6),
                     breaks = c(1, 1e3, 1e6, 1e9, 1e12), labels = c('1', '1K', '1M', '1B', '1T')) + 
  theme(legend.position = "bottom") + theme_bw()

# ggplot(data = sim0) + geom_line(aes(x = time/30, y = Bconc, color = 'naive B')) + geom_line(aes(x = time/30, y = Tconc, color = 'naive T')) + labs(y = 'cell count (#/uL peripheral blood)', x = 'time (months)', color = '') + theme_bw()

## test for neutrophil engraftment time
# assuming 90% of granulocytes are neutrophil
sim0$time[which(sim0$GMconc*0.9 > 500)][1:10]  #Ribeil et al., 2019 reported to be day 38


## quick check on RBC, RET, Hb recovery
RBC_ribeil <- read.csv('../../data/RBC_Ribeil.csv', header = T)
ret_ribeil <- data.frame(c(3,6,9,12,15), c(259000, 132000, 131000, 143000, 141000)) # unit in uL-1
names(ret_ribeil) <- c('month', 'RET')
hbinrbc_ribeil <- data.frame(c(3,6,9,12,15), c(34, 35, 36, 35, 35)) # unit in g.dL-1
names(hbinrbc_ribeil) <- c('month', 'HbinRBC')

Hb_ribeil <- read.csv('../../data/Hb_Ribeil.csv', header = T)
hb_hbs <- Hb_ribeil[Hb_ribeil['Hb'] == 'HbS',]
hb_hbaT87Q <- Hb_ribeil[Hb_ribeil['Hb'] == 'HbA_T87Q',]
hb_total <- Hb_ribeil[Hb_ribeil['Hb'] == 'Hb_total',]
  
HbAconc = ggplot() + 
  geom_line(data = sim0, aes(x = time/30, y = HbS, color = 'simul HbS')) + 
  geom_line(data = sim0, aes(x = time/30, y = HbA, color = 'simul HbA_T87Q')) + 
  geom_line(data = sim0, aes(x = time/30, y = totalHb, color = 'simul total Hb')) + 
  geom_point(data = hb_hbs, aes(x = month, y = Hbconc, color = 'HbS, Ribeil et al., 2017')) + 
  geom_point(data = hb_hbaT87Q, aes(x = month, y = Hbconc, color = 'HbA_T87Q, Ribeil et al., 2017')) + 
  geom_point(data = hb_total, aes(x = month, y = Hbconc, color = 'total Hb, Ribeil et al., 2017')) + 
  scale_x_continuous(breaks = c(0,3,6,9,12,15), limits = c(1, 15)) + 
  labs(y = 'hemoglobin conc (g/dL)', x = 'time (months)', color = '') + theme(legend.position = "bottom") + theme_bw()


RBCnum = ggplot() + 
  geom_line(data = sim0, aes(x = time/30, y = RBCconc, color = 'total RBC')) +
  geom_point(data = RBC_ribeil, aes(x = month, y = RBC_in_millions * 1e6, color = 'Ribeil et al., 2017')) + 
  labs(y = 'RBC count (#/uL)', x = 'time (months)', color = '') + 
  scale_x_continuous(breaks = c(0,3,6,9,12,15), limits = c(1, 15)) + 
  scale_y_continuous(limits = c(1, 4.5e6), breaks = c(1e6, 2e6, 3e6, 4e6), 
                     labels = c('1M', '2M', '3M', '4M')) + theme(legend.position = "bottom") + theme_bw()

RETnum = ggplot() + 
  geom_line(data = sim0, aes(x = time/30, y = RETconc, color = 'total RET')) + 
  geom_point(data = ret_ribeil, aes(x = month, y = RET, color = 'RET, Ribeil et al., 2017')) + 
  scale_x_continuous(breaks = c(0,3,6,9,12,15), limits = c(0, 15)) + 
  labs(y = 'RET count (#/uL)', x = 'time (months)', color = '') + theme(legend.position = "bottom") + theme_bw()


HbinRBCconc = ggplot() + 
  geom_line(data = sim0, aes(x = time/30, y = HbinRBC/10, color = 'Hb conc in RBC')) + 
  geom_point(data = hbinrbc_ribeil, aes(x = month, y = HbinRBC, color = 'Hb conc in RBC, Ribeil et al., 2017')) + 
  scale_x_continuous(breaks = c(0,3,6,9,12,15),  limits = c(3, 15)) + 
  labs(y = 'Hb in RBC (g/dL)', x = 'time (months)', color = '') + theme(legend.position = "bottom") + theme_bw() 

grid.arrange(HbAconc, RBCnum, RETnum, HbinRBCconc, ncol = 1)


# this is not terribly useful because we don't have monocyte in the model
neutrophilVCN_ribeil <- data.frame(c(2,4.5,6,9,12,15), c(1.89, 2.51, 2.84, 3.03, 2.12, 2.13)) 
names(neutrophilVCN_ribeil) <- c('month', 'neutrophilVCN')
pbmcVCN_ribeil <- data.frame(c(2,3,6,9,12,15), c(1.29, 2.15, 2.17, 2.86, 2.12, 2.11))
names(pbmcVCN_ribeil) <- c('month', 'pbmcVCN')

pbmcvcn <- ggplot() + 
  geom_line(data = sim0 %>% filter(time>15), aes(x = time/30, y = GM1/(GM0 + GM1)*2, color = 'granulocytes')) + 
  geom_line(data = sim0 %>% filter(time>15), aes(x = time/30, y = transT*2, color = 'naive T')) + 
  geom_line(data = sim0 %>% filter(time>15), aes(x = time/30, y = transB*2, color = 'naive B')) + 
  geom_point(data = neutrophilVCN_ribeil, aes(x = month, y = neutrophilVCN, color = 'neutrophil, Ribeil et al., 2017'), size = 3, alpha = 0.4) + 
  geom_point(data = pbmcVCN_ribeil, aes(x = month, y = pbmcVCN, color = 'PBMC, Ribeil et al., 2017'), alpha = 0.8) + 
  scale_x_continuous(breaks = c(0,3,6,9,12,15),  limits = c(0, 15)) + 
  labs(y = 'VCN per diploid genome', x = 'time (months)', color = '') + theme(legend.position = "bottom") + theme_bw() 


```


# Ex-vivo gene therapy

```{r}
patient1 <- read.csv('data/Aiuti2009.csv', header = TRUE) 

adahomo <- mread("human_ada")

# pre-equlibrium
pre_sim <- adahomo  %>% init(LT0 = 1000) %>%  mrgsim(end = 365 * 7) %>% as_tibble() %>% tail(n = 1) %>% select(-c(ID, time))

# set up preconditioning
ratioleft = 1-0.9

mod2 <- adahomo %>% init(pre_sim) %>% 
  init(pre_sim[,1:22] * ratioleft) %>% # progenitor in BM conditioning
  init(pre_sim[,67:72] * ratioleft) %>% # CLP and propreB conditioning
  init(pre_sim[,73:78] * ratioleft) %>% # splenic B cell conditioning
  init(pre_sim[,79:116] * ratioleft) %>% # thymic endures similar conditioning
  init(pre_sim[,117:130] * ratioleft) # conditioning on T cell outside thymus and GMs

## set up initial condition for testing
totalcd34 = 65e6

lthscinit = 1e-6 * totalcd34; 
sthscinit = 1e-5 * totalcd34; 
mppinit = 1e-3 * totalcd34;
cmpinit = 1e-2 * totalcd34;
clpinit = 1e-4 * totalcd34;
gmpinit = 1e-2 * totalcd34;
boeinit = 5e-2 * totalcd34;
biinit = 3e-2 * totalcd34; 

sim0 <- mod2 %>% init(LT1 = lthscinit, ST12 = sthscinit, MPP12 = mppinit, CMP12 = cmpinit, GMP12 = gmpinit, 
                       CLP1 = clpinit, Boe1 = boeinit, Bi1 = biinit) %>% 
        mrgsim(end = 365 * 7) %>% as_tibble() 

cd15plot = ggplot(data = sim0) + 
  geom_line(aes(x = time/365, y = GM1/(GM0 + GM1) * 100, color = 'simul')) + 
  geom_point(data = patient1 %>% filter(celltype == "CD15") ,aes(x = time, y = cellpercentage, color = 'obs'), size = 3) + 
  scale_y_continuous(trans='log10',  limits = c(0.1, 100), breaks = c(0.1, 1, 10, 100), labels = c('0.1','1', '10','100')) + 
  scale_x_continuous(limits = c(0, 7), breaks = c(0,1,2,3,4,5,6,7), labels = c('0','1', '2', '3', '4', '5', '6', '7')) + 
  labs(y = 'vector-positive cells (%)', x = 'time (year)', color = '') + theme(legend.position = "bottom") + theme_bw() + 
  ggtitle('CD15+ Granulocytic Cells')

cd19plot = ggplot(data = sim0) + 
  geom_line(aes(x = time/365, y = transB * 100, color = 'simul')) + 
  geom_point(data = patient1 %>% filter(celltype == "CD19") ,aes(x = time, y = cellpercentage, color = 'obs'), size = 3) + 
  scale_y_continuous(trans='log10',  limits = c(0.1, 100), breaks = c(0.1, 1, 10, 100), labels = c('0.1','1', '10','100')) + 
  scale_x_continuous(limits = c(0, 7), breaks = c(0,1,2,3,4,5,6,7), labels = c('0','1', '2', '3', '4', '5', '6', '7')) + 
  labs(y = 'vector-positive cells (%)', x = 'time (year)', color = '') + theme(legend.position = "bottom") + theme_bw() + 
  ggtitle('CD19+ B Cells')

cd3plot = ggplot(data = sim0) + 
  geom_line(aes(x = time/365, y = transT * 100, color = 'simul')) + 
  geom_point(data = patient1 %>% filter(celltype == "CD3") ,aes(x = time, y = cellpercentage, color = 'obs'), size = 3) + 
  scale_y_continuous(trans='log10',  limits = c(0.1, 100), breaks = c(0.1, 1, 10, 100), labels = c('0.1','1', '10','100')) + 
  scale_x_continuous(limits = c(0, 7), breaks = c(0,1,2,3,4,5,6,7), labels = c('0','1', '2', '3', '4', '5', '6', '7')) + 
  labs(y = 'vector-positive cells (%)', x = 'time (year)', color = '') + theme(legend.position = "bottom") + theme_bw() + 
  ggtitle('CD3+ T Cells')

png('img/aiutip1.png', width = 14, height = 3, unit = "in", res = 300)
grid.arrange(cd15plot, cd19plot, cd3plot, ncol = 3)
dev.off()
```